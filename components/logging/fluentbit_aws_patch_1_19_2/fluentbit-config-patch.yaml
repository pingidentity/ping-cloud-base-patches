apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: elastic-stack-logging
$patch: merge
data:
  fluent-bit.conf: |-
    [SERVICE]
        # Flush interval in seconds.
        # Lower value = lower latency, higher scheduler activity.
        Flush                     1

        # Run in foreground mode (required for containers).
        Daemon                    off

        # File containing parser definitions.
        Parsers_File              parsers.conf

        # ================= Resilience & Buffering =================

        # REQUIRED: Enable filesystem-backed storage engine.
        # Without this, all storage.* limits are ignored.
        storage.type              filesystem

        # Global filesystem buffer limit shared across ALL inputs & outputs.
        # When reached, all inputs are paused (global backpressure).
        storage.total_limit_size  500M

        # Base directory for filesystem buffering.
        # Must match the directory you monitor with `du`.
        storage.path              /fluent-bit/state/flb-storage

        # Use OS-level buffering for disk writes (good throughput).
        storage.sync              normal

        # Disable per-chunk checksum to reduce CPU overhead.
        storage.checksum          off

        # Maximum amount of RAM used for pending chunks
        # before aggressively spilling to disk.
        storage.backlog.mem_limit 50M

        # Maximum number of chunks allowed to be "up" (active).
        # Acts as a global safety valve under extreme ingestion.
        storage.max_chunks_up     2000

        # Expose storage-related metrics via the HTTP endpoint.
        storage.metrics           on

        # ================= Retry & Scheduler =================

        # Base retry delay (seconds); retries grow exponentially.
        scheduler.base            3

        # Maximum retry delay cap (seconds).
        scheduler.cap             180

        # ================= Shutdown Handling =================

        # Time allowed to flush data on SIGTERM.
        # Ensure k8s terminationGracePeriodSeconds > this value.
        Grace                     30

        # ================= Health & Metrics =================

        # Enable HTTP server for metrics and health checks.
        HTTP_Server               On
        HTTP_Listen               0.0.0.0
        HTTP_Port                 2020

        # Enables readiness based on pipeline health.
        Health_Check              On

    # ================= Pipelines =================
    # Inputs, filters, and outputs are defined separately.
    @INCLUDE elk.conf

