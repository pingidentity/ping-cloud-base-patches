apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: elastic-stack-logging
$patch: merge
data:
  fluent-bit.conf: |-
    [SERVICE]
        # Flush interval in seconds.
        Flush                     1

        # Run in foreground mode (required for containers).
        Daemon                    off

        # File containing parser definitions.
        Parsers_File              parsers.conf

        # ================= Resilience & Buffering =================

        # Base directory for filesystem buffering.
        storage.path              /fluent-bit/state/flb-storage

        # Use OS-level buffering for disk writes.
        storage.sync              normal

        # Disable per-chunk checksum to reduce CPU overhead in v4.x.
        storage.checksum          off

        # Maximum amount of RAM used for pending chunks before spilling to disk.
        # This acts as a global safety valve.
        storage.backlog.mem_limit 50M

        # Maximum number of chunks allowed to be "up" (active) in memory.
        # This ensures the pod doesn't exceed its memory limits during bursts.
        storage.max_chunks_up     2000

        # Enable storage-related metrics for monitoring and alerting.
        storage.metrics           on

        # ================= Retry & Scheduler =================

        # Modern Scheduler settings: retries grow exponentially.
        scheduler.base            3
        scheduler.cap             180

        # ================= Shutdown Handling =================

        # Time allowed to flush data on SIGTERM.
        Grace                     30

        # ================= Health & Metrics =================

        # Enable the HTTP server for the new /api/v1/health endpoint.
        HTTP_Server               On
        HTTP_Listen               0.0.0.0
        HTTP_Port                 2020

        # Enables readiness checks based on actual pipeline state (v3.x+ feature).
        Health_Check              On

    # ================= Pipelines =================
    # Include the separate pipeline definition file.
    @INCLUDE elk.conf
